- name: Setting timezone to Europe/Berlin
  timezone:
    name: Europe/Berlin

- name: Changing root password
  user:
    name: root
    password: "{{ root_password | password_hash('sha512') }}"

- name: Disabling admin group sudo permissions
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%admin'
    line: "# %admin ALL=(ALL) ALL"
    validate: 'visudo -cf %s'

- name: Creating docker group
  group:
    name: docker
    state: present

- name: Adding {{ remote_user_name }} and assign it to groups sudo, www-data
  user:
    name: "{{ remote_user_name }}"
    password: "{{ remote_user_password | password_hash('sha512') }}"
    groups: sudo,docker
    shell: /bin/zsh
    append: yes
    state: present
    createhome: yes

- name: Adding Docker GPG apt Key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Adding Docker apt Repository
  apt_repository:
    repo: deb https://download.docker.com/linux/ubuntu focal stable
    state: present
    update_cache: yes

- name: Installing basic apt dependencies
  apt:
    pkg: [ 'apt-transport-https', 'ca-certificates', 'curl', 'software-properties-common', 'fail2ban', 'ufw', 'unattended-upgrades', 'logwatch', 'zsh', 'vim', 'git', 'docker-ce', 'docker-compose', 'python3-pip', 'python3-dev' ]
    state: latest
    update_cache: yes
    cache_valid_time: 3600

- name: Installing python dependencies
  pip:
    name: [ 'setuptools', 'docker', 'docker-compose' ]
    state: present

- name: Enabling UFW logging
  ufw:
    logging: "on"

- name: Adding allow rules to UFW
  ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  with_items:
    - port: "3000" # Grafana
      proto: "tcp"

- name: Rate limit SSH login attempts
  ufw:
    rule: limit
    port: ssh
    proto: tcp

- name: Enabling UFW
  ufw:
    state: enabled
